#!/usr/bin/env sh

set -e

show_help() {
    echo "Usage: $0 [area|full] [OPTIONS]"
    echo ""
    echo "ARGUMENTS:"
    echo "  area            Screenshot selected area"
    echo "  full            Screenshot entire screen"
    echo ""
    echo "FLAGS:"
    echo "  -s, --save      Save screenshot to file"
    echo "  -c, --clipboard Copy to clipboard"
    echo "  -h, --help      Show this help"
}

if [ $# -eq 0 ]; then
    echo "Error: Specify 'area' or 'full'"
    show_help
    exit 1
fi

STATE_DIR="/run/user/$UID/hyprland"
mkdir -p "$STATE_DIR"
LOCKFILE="$STATE_DIR/screenshot.lock"
if [ -f "$LOCKFILE" ]; then
    echo "Screenshot already running (PID: $(cat "$LOCKFILE"))"
    exit 1
fi
echo $$ > "$LOCKFILE"
trap 'rm -f "$LOCKFILE"' EXIT INT TERM

TYPE=$1
shift

if [ "$TYPE" != "area" ] && [ "$TYPE" != "full" ]; then
    echo "Error: First argument must be 'area' or 'full'"
    show_help
    exit 1
fi

SAVE=false
CLIPBOARD=false

while [ $# -gt 0 ]; do
    case $1 in
        -s|--save)
            SAVE=true
            shift
            ;;
        -c|--clipboard)
            CLIPBOARD=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown flag: $1"
            show_help
            exit 1
            ;;
    esac
done

if [ "$SAVE" = false ] && [ "$CLIPBOARD" = false ]; then
    CLIPBOARD=true
fi

if [ "$SAVE" = true ]; then
    mkdir -p ~/screenshots
    FILENAME=~/screenshots/$(date +%Y%m%d-%H%M%S).png
fi

case $TYPE in
    "area")
        wayfreeze &
        WAYFREEZE_PID=$!
        sleep 0.1
        
        if [ "$SAVE" = true ] && [ "$CLIPBOARD" = true ]; then
            SELECTION=$(slurp)
            kill $WAYFREEZE_PID 2>/dev/null || true
            wait $WAYFREEZE_PID 2>/dev/null || true
            grim -g "$SELECTION" - | tee "$FILENAME" | wl-copy
            echo "Area screenshot saved to $FILENAME and copied to clipboard"
        elif [ "$SAVE" = true ]; then
            SELECTION=$(slurp)
            kill $WAYFREEZE_PID 2>/dev/null || true
            wait $WAYFREEZE_PID 2>/dev/null || true
            grim -g "$SELECTION" "$FILENAME"
            echo "Area screenshot saved to $FILENAME"
        else
            SELECTION=$(slurp)
            kill $WAYFREEZE_PID 2>/dev/null || true
            wait $WAYFREEZE_PID 2>/dev/null || true
            grim -g "$SELECTION" - | wl-copy
            echo "Area screenshot copied to clipboard"
        fi
        ;;
    "full")
        if [ "$SAVE" = true ] && [ "$CLIPBOARD" = true ]; then
            grim - | tee "$FILENAME" | wl-copy
            echo "Full screen screenshot saved to $FILENAME and copied to clipboard"
        elif [ "$SAVE" = true ]; then
            grim "$FILENAME"
            echo "Full screen screenshot saved to $FILENAME"
        else
            grim - | wl-copy
            echo "Full screen screenshot copied to clipboard"
        fi
        ;;
esac
